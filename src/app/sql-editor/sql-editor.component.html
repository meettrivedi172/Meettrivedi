<div class="sql-editor-container">
  <!-- Tabs -->
  <div class="tabs">
    <button class="tab-button" [class.active]="activeTab === 'sql'" (click)="onTabChange('sql')">
      SQL Editor
    </button>
    <button class="tab-button" [class.active]="activeTab === 'visual'" (click)="onTabChange('visual')">
      Visual Builder
    </button>
    <button class="tab-button" [class.active]="activeTab === 'json'" (click)="onTabChange('json')">
      Query JSON
    </button>
  </div>

  <!-- SQL Editor Tab -->
  <div [style.display]="activeTab === 'sql' ? 'flex' : 'none'" class="tab-content sql-tab">
    <!-- Toolbar -->
    <!-- <div class="toolbar">
      <button 
        class="toolbar-button execute-btn" 
        (click)="executeQuery()"
        [disabled]="isExecuting"
      >
        @if (isExecuting) {
          <div class="spinner-small"></div>
        } @else {
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <path d="M3 3L13 8L3 13V3Z" fill="currentColor"/>
          </svg>
        }
        <span>Execute Query</span>
      </button>
      
      <button 
        class="toolbar-button validate-btn"
        (click)="validateQueryOnly()"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
        </svg>
        <span>Validate</span>
      </button>
      
      <button 
        class="toolbar-button format-btn"
        (click)="formatQuery()"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M5 4H13M5 8H13M5 12H11M3 3H3V5H3M3 7H3V9H3M3 11H3V13H3" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>Format</span>
      </button>
      
      <div class="toolbar-spacer"></div>
      
      <button 
        class="toolbar-button clear-btn"
        (click)="clearEditor()"
      >
        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
        </svg>
        <span>Clear</span>
      </button>
      
      <div class="editor-info">
        {{ getLineAndColumn() }} • SQL Mode
      </div>
    </div> -->

    <!-- Monaco Editor -->
    <!-- <div class="editor-wrapper">
      <div 
        #editorContainer 
        class="monaco-editor-container"
        style="width: 100%; height: 100%; min-height: 400px;"
      ></div>
    </div> -->

    <!-- Validation Errors Panel -->
    <!-- @if (showValidationErrors) {
      @if (validationErrors.length > 0) {
        <div class="validation-errors-panel">
          <div class="validation-errors-header">
            <div class="validation-errors-title">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M10 6V10M10 14H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Validation Errors ({{ validationErrors.length }})</span>
            </div>
            <button class="close-errors-btn" (click)="dismissValidationErrors()" title="Close">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
          <div class="validation-errors-list">
            @for (error of validationErrors; track $index) {
              <div class="validation-error-item" [class.error]="error.severity === 'error'" [class.warning]="error.severity === 'warning'">
                <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                  @if (error.severity === 'error') {
                    <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 5V8M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  } @else {
                    <path d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                    <path d="M8 6V8M8 10H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                  }
                </svg>
                <span class="error-message">{{ error.message }}</span>
                @if (error.line) {
                  <span class="error-location">Line {{ error.line }}</span>
                }
              </div>
            }
          </div>
        </div>
      } @else if (validationSuccess) {
        <div class="validation-success-panel">
          <div class="validation-success-header">
            <div class="validation-success-title">
              <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                <path d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                <path d="M6 10L9 13L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
              <span>Query is valid!</span>
            </div>
            <button class="close-errors-btn" (click)="dismissValidationErrors()" title="Close">
              <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            </button>
          </div>
        </div>
      }
    } -->

    <!-- Parameters Panel -->
    <!-- @if (parameters.length > 0) {
      <div class="parameters-panel">
        <div class="parameters-header">
          <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
            <circle cx="8" cy="8" r="5" stroke="currentColor" stroke-width="1.5"/>
            <circle cx="8" cy="8" r="1.5" fill="currentColor"/>
            <path d="M8 3V4M8 12V13M13 8H12M4 8H3M11.4645 4.53553L10.6569 5.34315M5.34315 10.6569L4.53553 11.4645M11.4645 11.4645L10.6569 10.6569M5.34315 5.34315L4.53553 4.53553" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
          </svg>
          <span>Query Parameters</span>
        </div>
        <div class="parameters-grid">
          @for (param of parameters; track param.name) {
            <div class="parameter-item">
              <label class="parameter-label">
                {{ param.name }}
                @if (param.required) {
                  <span class="required-asterisk">*</span>
                }
              </label>
              
              @if (param.type === 'lookup') {
                <select 
                  class="parameter-input parameter-select"
                  [(ngModel)]="param.value"
                  (change)="onParameterChange(param)"
                >
                  <option value="">Select...</option>
                  <option value="1">Option 1</option>
                  <option value="2">Option 2</option>
                </select>
              } @else if (param.type === 'date') {
                <input 
                  type="date"
                  class="parameter-input"
                  [(ngModel)]="param.value"
                  (change)="onParameterChange(param)"
                />
              } @else if (param.type === 'number') {
                <input 
                  type="number"
                  class="parameter-input"
                  [(ngModel)]="param.value"
                  (change)="onParameterChange(param)"
                />
              } @else {
                <input 
                  type="text"
                  class="parameter-input"
                  [(ngModel)]="param.value"
                  (change)="onParameterChange(param)"
                  placeholder="Enter {{ param.name }}"
                />
              }
            </div>
          }
        </div>
      </div>
    } -->

    <!-- Query Results Panel -->
    <!-- @if (showResults && queryResults && queryResults.success && queryResults.data) {
      <div class="query-results-panel">
        <app-results-grid
          [data]="queryResults.data"
          [columns]="getResultColumns()"
          [metadata]="queryResults.metadata"
          [enableFiltering]="true"
          [enableSorting]="true"
          [enableGrouping]="true"
          [pageSize]="50"
          (filterChange)="onGridFilterChange($event)"
          (sortChange)="onGridSortChange($event)"
          (groupChange)="onGridGroupChange($event)"
          (sqlUpdate)="onSQLUpdateRequested()"
        ></app-results-grid>
      </div>
    } @else if (showResults && queryResults && !queryResults.success) {
      <div class="query-results-panel">
        <div class="query-results-error">
          <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
            <path d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
            <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          <h3>Query Execution Failed</h3>
          <p>{{ queryResults.error || 'Unknown error occurred' }}</p>
        </div>
      </div>
    } -->


    <div id="target" class="control-section default-splitter">
      <div class="pane1">
        <ejs-splitter #vertical height='1000px' separatorSize=2 width='100%' orientation='Vertical'>
          <e-panes>
            <e-pane size='25%' min='255px'>
              <ng-template #content>
                <div class="content pane-content">
                  <div class="toolbar">
                    <button class="toolbar-button execute-btn" (click)="executeQuery()" [disabled]="isExecuting">
                      @if (isExecuting) {
                      <div class="spinner-small"></div>
                      } @else {
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M3 3L13 8L3 13V3Z" fill="currentColor" />
                      </svg>
                      }
                      <span>Execute Query</span>
                    </button>

                    <button class="toolbar-button validate-btn" (click)="validateQueryOnly()">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13.5 4L6 11.5L2.5 8" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round" />
                      </svg>
                      <span>Validate</span>
                    </button>

                    <button class="toolbar-button format-btn" (click)="formatQuery()">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M5 4H13M5 8H13M5 12H11M3 3H3V5H3M3 7H3V9H3M3 11H3V13H3" stroke="currentColor"
                          stroke-width="2" stroke-linecap="round" />
                      </svg>
                      <span>Format</span>
                    </button>

                    <div class="toolbar-spacer"></div>

                   

                    <div class="toolbar-spacer"></div>

                    <!-- <button class="toolbar-button save-btn" (click)="openSaveQueryModal()" title="Save Query">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M13 4L12 3L9 0H2C1.44772 0 1 0.447715 1 1V15C1 15.5523 1.44772 16 2 16H14C14.5523 16 15 15.5523 15 15V5L13 4Z" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M9 0V5H15" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                        <path d="M4 8H12M4 12H12" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                      <span>Save</span>
                    </button>

                    <button class="toolbar-button saved-queries-btn" (click)="openSavedQueriesSidebar()" title="Saved Queries">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M2 3C2 2.44772 2.44772 2 3 2H13C13.5523 2 14 2.44772 14 3V13C14 13.5523 13.5523 14 13 14H3C2.44772 14 2 13.5523 2 13V3Z" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M2 6H14M6 2V6M10 2V6" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"/>
                      </svg>
                      <span>Saved</span>
                    </button>

                    
                     <button class="toolbar-button history-btn" (click)="openQueryHistorySidebar()" title="Query History">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <circle cx="8" cy="8" r="6" stroke="currentColor" stroke-width="1.5"/>
                        <path d="M8 4V8L10 10" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      <span>History</span>
                    </button>
                   -->


                     <button class="toolbar-button clear-btn" (click)="clearEditor()">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round" />
                      </svg>
                      <span>Clear</span>
                    </button>

                    <div class="editor-info">
                      {{ getLineAndColumn() }} • SQL Mode
                    </div>
                  </div>

                  <!-- Monaco Editor -->
                  <div class="editor-wrapper">
                    <div #editorContainer class="monaco-editor-container"></div>
                  </div>

                  <!-- Validation Errors Panel -->
                  @if (showValidationErrors) {
                  @if (validationErrors.length > 0) {
                  <div class="validation-errors-panel">
                    <div class="validation-errors-header">
                      <div class="validation-errors-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                          <path
                            d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M10 6V10M10 14H10.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        </svg>
                        <span>Validation Errors ({{ validationErrors.length }})</span>
                      </div>
                      <button class="close-errors-btn" (click)="dismissValidationErrors()" title="Close">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                        </svg>
                      </button>
                    </div>
                    <div class="validation-errors-list">
                      @for (error of validationErrors; track $index) {
                      <div class="validation-error-item" [class.error]="error.severity === 'error'"
                        [class.warning]="error.severity === 'warning'">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                          @if (error.severity === 'error') {
                          <path
                            d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M8 5V8M8 11H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                          } @else {
                          <path
                            d="M8 14C11.3137 14 14 11.3137 14 8C14 4.68629 11.3137 2 8 2C4.68629 2 2 4.68629 2 8C2 11.3137 4.68629 14 8 14Z"
                            stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M8 6V8M8 10H8.01" stroke="currentColor" stroke-width="1.5" stroke-linecap="round"
                            stroke-linejoin="round" />
                          }
                        </svg>
                        <span class="error-message">{{ error.message }}</span>
                        @if (error.line) {
                        <span class="error-location">Line {{ error.line }}</span>
                        }
                      </div>
                      }
                    </div>
                  </div>
                  } @else if (validationSuccess) {
                  <div class="validation-success-panel">
                    <div class="validation-success-header">
                      <div class="validation-success-title">
                        <svg width="20" height="20" viewBox="0 0 20 20" fill="none">
                          <path
                            d="M10 18C14.4183 18 18 14.4183 18 10C18 5.58172 14.4183 2 10 2C5.58172 2 2 5.58172 2 10C2 14.4183 5.58172 18 10 18Z"
                            stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                          <path d="M6 10L9 13L14 7" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                            stroke-linejoin="round" />
                        </svg>
                        <span>Query is valid!</span>
                      </div>
                      <button class="close-errors-btn" (click)="dismissValidationErrors()" title="Close">
                        <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                          <path d="M12 4L4 12M4 4L12 12" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" />
                        </svg>
                      </button>
                    </div>
                  </div>
                  }
                  }

                  <!-- Parameters Panel -->
                  <!-- @if (parameters.length > 0) {
                  <div class="parameters-panel">
                    <div class="parameters-header">
                      <svg width="16" height="16" viewBox="0 0 16 16" fill="none">
                        <circle cx="8" cy="8" r="5" stroke="currentColor" stroke-width="1.5" />
                        <circle cx="8" cy="8" r="1.5" fill="currentColor" />
                        <path
                          d="M8 3V4M8 12V13M13 8H12M4 8H3M11.4645 4.53553L10.6569 5.34315M5.34315 10.6569L4.53553 11.4645M11.4645 11.4645L10.6569 10.6569M5.34315 5.34315L4.53553 4.53553"
                          stroke="currentColor" stroke-width="1.5" stroke-linecap="round" />
                      </svg>
                      <span>Query Parameters</span>
                    </div>
                    <div class="parameters-grid">
                      @for (param of parameters; track param.name) {
                      <div class="parameter-item">
                        <label class="parameter-label">
                          {{ param.name }}
                          @if (param.required) {
                          <span class="required-asterisk">*</span>
                          }
                        </label>

                        @if (param.type === 'lookup') {
                        <select class="parameter-input parameter-select" [(ngModel)]="param.value"
                          (change)="onParameterChange(param)">
                          <option value="">Select...</option>
                          <option value="1">Option 1</option>
                          <option value="2">Option 2</option>
                        </select>
                        } @else if (param.type === 'date') {
                        <input type="date" class="parameter-input" [(ngModel)]="param.value"
                          (change)="onParameterChange(param)" />
                        } @else if (param.type === 'number') {
                        <input type="number" class="parameter-input" [(ngModel)]="param.value"
                          (change)="onParameterChange(param)" />
                        } @else {
                        <input type="text" class="parameter-input" [(ngModel)]="param.value"
                          (change)="onParameterChange(param)" placeholder="Enter {{ param.name }}" />
                        }
                      </div>
                      }
                    </div>
                  </div>
                  } -->

                </div>
              </ng-template>
            </e-pane>
            <e-pane size='75%' min='60px'>
              <ng-template #content>
                <div class="content pane-content">
                  <!-- Query Results Panel -->
                  @if (showResults && queryResults && queryResults.success && queryResults.data) {
                  <div class="query-results-panel">
                    <app-results-grid [data]="queryResults.data" [columns]="getResultColumns()"
                      [metadata]="queryResults.metadata" [enableFiltering]="true" [enableSorting]="true"
                      [enableGrouping]="true" [pageSize]="50" (filterChange)="onGridFilterChange($event)"
                      (sortChange)="onGridSortChange($event)" (groupChange)="onGridGroupChange($event)"
                      (sqlUpdate)="onSQLUpdateRequested()"></app-results-grid>
                  </div>
                  } @else if (showResults && queryResults && !queryResults.success) {
                  <div class="query-results-panel">
                    <div class="query-results-error">
                      <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                        <path
                          d="M12 22C17.5228 22 22 17.5228 22 12C22 6.47715 17.5228 2 12 2C6.47715 2 2 6.47715 2 12C2 17.5228 6.47715 22 12 22Z"
                          stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" />
                        <path d="M12 8V12M12 16H12.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                          stroke-linejoin="round" />
                      </svg>
                      <h3>Query Execution Failed</h3>
                      <p>{{ queryResults.error || 'Unknown error occurred' }}</p>
                    </div>
                  </div>
                  }
                </div>
              </ng-template>
            </e-pane>
          </e-panes>
        </ejs-splitter>
      </div>
    </div>

  </div>












  <!-- Visual Builder Tab -->
  <div [style.display]="activeTab === 'visual' ? 'flex' : 'none'" class="tab-content visual-tab">
    <app-visual-query-builder
      [sqlQuery]="sqlQuery"
      [forceParse]="forceVisualParse"
      [isTabActive]="activeTab === 'visual'"
      [isExecuting]="isExecuting"
      (sqlQueryChange)="onVisualBuilderSQLChange($event)"
      (syncWarning)="onVisualBuilderWarning($event)"
      (executeQuery)="executeQuery()"
    ></app-visual-query-builder>
  </div>

  <!-- Query JSON Tab -->
  <div [style.display]="activeTab === 'json' ? 'flex' : 'none'" class="tab-content json-tab">
    <div class="json-viewer">
      <!-- <div class="json-actions">
        <button class="btn btn-primary" (click)="convertJsonToSql()" [disabled]="!jsonInput || jsonInput.trim() === ''">
          Convert JSON to SQL
        </button>
        <button class="btn btn-secondary" (click)="loadJsonFromSql()">
          Load JSON from SQL
        </button>
      </div> -->
      <div class="json-input-section">
        <label>Paste JSON Query Object:</label>
        <textarea 
          class="json-input" 
          [(ngModel)]="jsonInput" 
          placeholder='Paste JSON here, e.g. { "QueryObjectID": "WorkItems", "ResultField_AppfieldIds": ["ID", "Title"], ... }'
          rows="15">
        </textarea>
      </div>
      <!-- <div class="json-output-section">
        <label>Generated SQL:</label>
        <pre class="json-output">{{ formattedQuery }}</pre>
      </div> -->
    </div>
  </div>

  <!-- Query Management Components -->
  <app-save-query-modal
    [isOpen]="showSaveQueryModal"
    [existingQuery]="editingQuery"
    [sqlText]="sqlQuery"
    [queryJson]="getQueryJson()"
    [parameterValues]="getParameterValues()"
    (close)="closeSaveQueryModal()"
    (save)="onSaveQuery($event)"
  ></app-save-query-modal>

  <app-saved-queries-sidebar
    [isOpen]="showSavedQueriesSidebar"
    (close)="closeSavedQueriesSidebar()"
    (loadQuery)="onLoadSavedQuery($event)"
    (editQuery)="onEditSavedQuery($event)"
  ></app-saved-queries-sidebar>

  <app-query-history-sidebar
    [isOpen]="showQueryHistorySidebar"
    (close)="closeQueryHistorySidebar()"
    (loadQuery)="onLoadQueryFromHistory($event)"
  ></app-query-history-sidebar>
</div>